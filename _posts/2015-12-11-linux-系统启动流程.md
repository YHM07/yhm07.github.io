---
layout: post
title:  "linux学习笔记十--linux系统启动流程"
keywords: ""
description: ""
category: "Linux" 
tags: [linux系统内核启动流程]
---

**@(linux)[linux进程管理]**

## linux系统启动流程
---

PC: OS(linux)

> POST(Power On Self Test,加电自检)-->BIOS(Boot Sequence:Boot启动次序)-->MBR(bootloader,446bytes)-->Kernel-->initrd(init ramfs)-->init(/sbin/init)


> 
* 文件系统
* 进程管理
* 内存管理
* 网络管理
* 安全功能
* 驱动程序

<!-- more -->

### 启动服务

运行级别: 0-6

>
- 0: halt
- 1: single user mode,直接以管理员身份运行,别名s,S,single
- 2: multi user mode, no NFS
- 3: multi user mode, text mode 
- 4: reserved 
- 5: multi user mode, graphic mode 
- 6: reboot 


### grub 配置文件

> /etc/grub.conf --> /boot/grub/grub.conf 

```bash
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/CentOSVirtual-Root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=0   # 设定默认启动的title编号,从0开始
timeout=5   # 设定用户选择的超时时间,单位是秒
splashimage=(hd0,0)/grub/splash.xpm.gz   # **grub 背景图片**
hiddenmenu # 隐藏菜单
title CentOS (2.6.32-573.8.1.el6.x86_64) # **内核标题,或操作系统名称,字符串,可自由修改**
        root (hd0,0) # **内核文件所在的设备,对grub而言,所有类型硬盘一律为hd,格式为(hdM,N), hdM,M表示第几块硬盘,N表示该硬盘的第几个分区**
        kernel /vmlinuz-2.6.32-573.8.1.el6.x86_64 ro root=/dev/mapper/CentOSVirtual-Root rd_NO_LUKS rd_LVM_LV=CentOSVirtual/Swap LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=CentOSVirtual/Root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet # **内核文件路劲,及传递给内核的参数**
        initrd /initramfs-2.6.32-573.8.1.el6.x86_64.img # **ramdisk文件路径**
title CentOS (2.6.32-573.7.1.el6.x86_64)
        root (hd0,0)
        kernel /vmlinuz-2.6.32-573.7.1.el6.x86_64 ro root=/dev/mapper/CentOSVirtual-Root rd_NO_LUKS rd_LVM_LV=CentOSVirtual/Swap LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=CentOSVirtual/Root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
        initrd /initramfs-2.6.32-573.7.1.el6.x86_64.img
```

> /boot单独分区时,ramdisk文件路径以根目录开始,(根目录事实上是指的/boot),文件路径为/initramfs-2.6.32-573.8.1.el6.x86_64.img
> 如果/boot没有单独分区,ramdisk文件路径为/boot/initramfs-2.6.32-573.8.1.el6.x86_64.img

### 查看运行级别

	runlevel 

	who -r

查看内核release号

	uname -r

## grub安装
---

安装grub stage1

```bash
$ grub  # 启动grub
grub> root (hd0,0)  # 设置root
grub> set (hd0) # 启动
``` 


安装grub的第二种方式

	grub-install --root-directory=/path/to/boot's-parent-directory /path/to/DEVICE

首先，创建新分区'/dev/sdb1'，然后格式化`mke2fs -j /dev/sdb1`,挂载`mount /dev/sdb1 /mnt/boot`,如果没有该目录，首先创建`mkdir /mnt/boot`,必须创建**boot**目录。最后运行`grub-install --root-directory=/mnt /dev/sdb`生成grub。此时会在**/mnt/boot**目录下生成**grub**目录。最后编辑生成配置文件**/mnt/boot/grub/grub.conf**。

### grub界面启动

```bash
grub> find (hd0,0)/  # find 命令可以查询
grub> root (hdM,N)  # 设置root根目录
grub> kernel  /path/to/kernel-file  
grub> initrd  /path/to/initrd-file
grub> boot # 按TAB键可以自动补全
```

### Kernel 初始化过程

> 
1. 设备探测
2. 驱动初始化(可能从initrd [initramfs] 文件中装载驱动模块)
3. 以只读方式挂载根文件系统
4. 装载第一个进程init(pid:1)

### /sbin/init (配置文件/etc/inittab)

> upstatrt:  RedHat6.0 后使用**upstart(ubuntu开发，可以并行启动进程)**,基于**d-bus**配置，基于事件驱动的方式
> systemd:  并行启动进程

配置文件：**/etc/inittab**

	id:runlevels:action:process

> id:  标识符
> runlevels：在哪个级别运行此程序
> action：在什么情况或事件下执行此行
> process：要运行的程序

action:
> initdefault: 设定默认运行级别
> sysinit：系统初始化
> wait：等待级别切换至此时完成
> ctrlaltdel：
> powerfail：
> powerokwait：
> respawn: 一旦程序终止会重新启动

### /etc/rc.d/rc.sysinit 完成的任务：

>
1. 激活udev和selinux
2. 根据/etc/sysctl.conf文件，设定内核参数
3. 设定时钟
4. 装载键盘映射
5. 启用交换分区
6. 设置主机名
7. 根文件系统检测，并以读写方式重新挂载
8. 激活RAID和LVM设备
9. 启用磁盘配额
10. 根据/etc/fstab, 检查并挂载其他文件系统
11. 清理过期的锁和PID文件

### 服务类脚本(/etc/rc.d/init.d /etc/init.d/)

	SysV:  /etc/rc.d/init.d  {start|stop|restart|status| reload |configtest(测试脚本是否有语法错误)}

/etc/init.d/service-name 共同点：均含有以下两行,**chkconfig description**

\# chkconfig:  runlevels SS KK 

> 当使用`chkconfig`命令来为某脚本在**rc#.d**目录创建连接时,runlevels表示默认创建S\*开头的链接，**-**表示，没有级别，默认为S*开头的链接，除此之外的级别默认创建为K\*开头的链接。
> S后面的启动优先级为SS所表示的数字，K后面关闭优先级次序为KK所表示的数字

> runlevels: 指定运行级别，可以使用**-**表示，没有级别，默认为S*开头的链接
> SS 在指定运行级别

\# description： # 说明此脚本的简单功能, 可以使用**\\**换行

### chkconfig 命令使用

```bash 
chkconfig --list # 查看所有独立守护服务的启动设定，独立守护进程
chkconf --list service-name 

chkconfig --add service-name # 添加独立守护进程,仅表示在下次启动系统时生效
chkconfig --del service-name # 添加独立守护进程

chkconfig --add /etc/init.d/daemon-scripts # 添加独立守护进程

chkconfig [--level RUNLEVELS] service-name on|off # 指定运行级别启动或关闭指定独立守护进程,如果省略级别指定,默认为2345级别
```

**/etc/rc.d/rc.local # 系统最后启动的一个脚本,可以放置自定义命令**

### 启动终端(/sbin/mingetty)

### /etc/inittab任务

>
1. 设定默认运行级别
2. 运行系统初始化脚本
3. 运行指定运行级别对应目录下的脚本
4. 设定ctrl+alt+del组合键的操作
5. 定义UPS电源的电源故障或恢复时执行的操作
6. 启动虚拟终端(runlevels:2345)
7. 启动图形终端(runlevels:5)

### 守护进程

- 独立守护进程

	xinetd： 超级守护进程，管理瞬时守护进程，需要关联至运行级别

- 瞬时守护进程，不需要关联至运行级别

